# 분산 락 (Distributed Lock)

분산 시스템 환경에서 여러 프로세스나 서버가 공유 자원에 동시에 접근하는 것을 제어하기 위한 메커니즘이다.  

분산 락이라고 부르는 이유는...  

1. 분산된 애플리케이션(서버) 환경에서 동기화가 필요하기 때문
2. 분산된 애플리케이션이 중앙화된 잠금 메커니즘이 필요하기 때문
3. 단일 프로세스나 스레드 간의 동기화가 아니라, 물리적으로 분리된 상황에서의 동기화가 필요하기 때문

Redis는 원자적 명령어와 빠른 응답 시간 덕분에 분산 락을 구현할 때 자주 사용된다.  


## 분산 락은 Redis가 기본적으로 제공하는 기능이 아니다.
Redis가 분산 락이라는 기능 자체를 제공하는 것이 아니라 Redis의 원자적 명령어들(Atomic Operations)를 활용하여 직접 구현하는 패턴을 의미한다.  

## Spin Lock 방식

**Spin Lock** 이란, 락을 획득하지 못했을 때 즉시 포기하지 않고 일정 시간 동안 반복적으로 락 획득을 시도하는 방식이다.  
`SETNX`나 `SET NX` 명령어를 짧은 간격으로 계속 시도한다.  
구현이 단순하다는 장점이 있고, 락 경합이 짧을 때 효율적이다. CPU 자원을 많이 소모할 수 있으며? 시스템에 불필요한 부하를 발생 시킬 수도 있다.  

### `SETNX` 기반의 락
- `SETNX`(SET if Not eXists) 명령어를 사용
- 키가 존재하지 않을 때만 값을 설정
- 단점
    - 락 획득 후 서버 장애 시 락이 영구적으로 남을 수 있다.
    - Redis 초기 버전부터 제공된 명령어이며 레거시 호환성을 위해 유지되고 있다.
    - 만료 시간을 설정할 수 없다.

### `SET` 명령어와 `NX`, `EX`, `PX` 옵션을 활용한 락
- `SET key value NX PX 30000` 같이 옵션을 조합하는 패턴
- 락 획득과 동시에 타임아웃 설정 가능하여 데드락 방지
- `NX` 옵션: 키가 존재하지 않을 때만 설정
- `EX` 옵션: 키의 만료 시간을 초 단위로 설정
- `PX` 옵션: 키의 만료 시간을 밀리초 단위로 설정 (더 정밀한 제어는

## Pub/Sub 방식
락이 해제될 때 특정 채널에 메시지가 발행되어 모든 구독자(애플리케이션)는 알림을 받았을 락 획득을 시도하는 방식이다.  
잦은 폴링이 없기 때문에 시스템 부하가 적을 수도 있다?  


## 더 읽어볼 거리
- [Redis 분산 락 - Pub/Sub 과 Spin Lock의 성능](https://m.blog.naver.com/kwon37xi/223775157674)